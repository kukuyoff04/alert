# ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå: .github/workflows/water_alert.yml
# ‚ÄºÔ∏è ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï (v6) ‚ÄºÔ∏è

name: üåä Inburi Water Level Alert

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  scrape-and-notify:
    runs-on: ubuntu-latest
    permissions:
      # ‡πÉ‡∏´‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏ü‡∏•‡πå (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö commit)
      contents: write
      
    steps:
      - name: 1. Check out repository
        uses: actions/checkout@v4

      - name: 2. Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: 3. Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 4. Install Playwright browser
        run: playwright install --with-deps chromium

      # ‚¨áÔ∏è ‡πÄ‡∏û‡∏¥‡πà‡∏° 'id: scrape' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ step ‡∏≠‡∏∑‡πà‡∏ô‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÑ‡∏î‡πâ ‚¨áÔ∏è
      - name: 5. Run scraper script
        id: scrape # ‚¨ÖÔ∏è ‡πÄ‡∏û‡∏¥‡πà‡∏° ID
        env:
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
        run: python scrape_water.py
      
      # ‚¨áÔ∏è Step ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô "‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠ Step 5 ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß" ‚¨áÔ∏è
      - name: 6. Upload Debug Screenshot on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: debug-screenshot
          path: debug_screenshot.png
          retention-days: 5

      # ‚¨áÔ∏è Step ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô "‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠ Step 5 ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" ‚¨áÔ∏è
      - name: 7. Configure Git (on Success)
        if: success()
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
      
      # ‚¨áÔ∏è Step ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô "‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠ Step 5 ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" ‚¨áÔ∏è
      - name: 8. Commit and push changes (on Success)
        if: success()
        run: |
          # ‡πÄ‡∏£‡∏≤‡∏à‡∏∞ add ‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏±‡∏ô‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
          if [ -f "last_level.txt" ]; then
            git add last_level.txt
            if git diff-index --quiet HEAD; then
              echo "No changes in water level, skipping commit."
            else
              git commit -m "Update last water level"
              git push
            fi
          else
            echo "last_level.txt not found, skipping commit."
          fi
